<!DOCTYPE html>
<html>
<head>
    <title>Accessible App</title>
    <!--  (c) 2013 Rally Software Development Corp.  All Rights Reserved. -->
    <!--  Build Date: Mon Jul 08 2013 19:14:18 GMT-0700 (PDT) -->
    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
             
Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',
    
    projectSelector: null,
    projectStore: null,
    grid: null,

    table_size: 10,
    items: [ 
        {xtype:'container', items: [ 
            {xtype: 'container', html: '<h1>Top of the App</h1> ' +
                    '<p>This app allows a user to select a project and find stories within that project. ' +
                    'Below this paragraph, there is a combobox listing projects and a button that starts the query. ' +
                    'The app will generate a table of the first ten user stories for the selected project.</p>' }
        ]},
        {xtype:'container',itemId:'selector_box', defaults: { padding: 5, margin: 5 }, layout: { type: 'hbox' } },
        {xtype:'container',itemId:'grid_box' },
        {xtype:'container', items: [
            {xtype:'container',html:'<h1>Alerts</h1>'},
            {xtype:'container',itemId:'alert_area',id:'alert_area'}
        ]}
    ],

    _log: function(msg) {
        window.console && console.log( msg );  
    },
    
    _alert: function(message) {
        this.down('#alert_area').removeAll();
        this.down('#alert_area').add({ xtype:'container',html:'<span role="alert">' + message + "</span>"});

        var objHidden = document.getElementById('virtualbufferupdate');
    
        if (objHidden)
        {
            if (objHidden.getAttribute('value') == '1') {
                objHidden.setAttribute('value', '0');
            } else {
                objHidden.setAttribute('value', '1');
            }
        } else {
            this._prepareBuffer();
        }
    },
    _prepareBuffer: function(){
        var objNew = document.createElement('p');
        var objHidden = document.createElement('input');
    
        objHidden.setAttribute('type', 'hidden');
        objHidden.setAttribute('value', '1');
        objHidden.setAttribute('id', 'virtualbufferupdate');
        objHidden.setAttribute('name', 'virtualbufferupdate');
    
        objNew.appendChild(objHidden);
        Ext.getBody().appendChild(objNew);
    },
    launch: function() {       
        Ext.getBody().set({ role: 'application' });
        this._alert("The application is loading.");
        this._prepareBuffer();
        this.projectStore = Ext.create('Rally.data.WsapiDataStore', {
            model: 'Project',
            autoLoad: true,
            fetch: ['ObjectID', 'Name'],
            listeners: {
                load: this._onProjectStoreLoaded,
                scope: this
            },
            filters: [
                {
                    property: 'State',
                    value: 'Open'
                }
            ],
            sorters: [
                {
                    property: 'Name',
                    direction: 'ASC'
                }
            ]
        });                                
    },
    
    _onProjectStoreLoaded: function(store, data) {
        
        this.projectSelector = Ext.create('Rally.technicalservices.accessible.Combobox', {
            store: store,
            componentId: 'projectSelector'
        });
        
        this.down('#selector_box').add(this.projectSelector);
        
        this.down('#selector_box').add({
            xtype: 'button',
            text: 'Get Stories',
            buttonLabel : 'Get Stories',
            handler: this._getStories,
            scope: this
        });   

        Ext.get('alert_area').set({role:'alert'});
        this._alert("The application is loaded and available in an iFrame on the page. Please navigate to the iFrame for a more full description.");
    },
    
    
    // Loads/refreshes grid with subset of Stories from selected project
    _getStories: function() {
        this._log('_getStories');
        var me = this;
        // Get the ref of the selected project
        var selectedProjectRef = projectSelector.value;
        var selectedProjectName = projectSelector.options[projectSelector.selectedIndex].text;
        this._alert("Loading Stories for " + selectedProjectName + " project." );

        // Clear out existing grid if present
        if (this.grid) {
            this.remove(this.grid);
        }
        
        var store = Ext.create('Rally.data.WsapiDataStore',{
            model: 'User Story',
            limit: me.table_size,
            pageSize: me.table_size,
            context: {
                project: selectedProjectRef,
                projectScopeUp: false,
                projectScopeDown: false
            },
            autoLoad:true,
            listeners: {
                scope: this,
                load: function(store,data,success){
                    this._makeGrid(store);
                }
            }
        });
        
    },
    
    _makeGrid: function(store) {
        if (this.grid) { this.grid.destroy(); }
        
        this.grid = Ext.create('Rally.technicalservices.accessible.grid',{
            store: store,
            title: 'User Stories',
            caption: 'Table of User Stories',
            columns: [
                {text:'ID', dataIndex:'FormattedID'},
                {text:'Name', dataIndex:'Name'},
                {text:'Schedule State', dataIndex:'ScheduleState'}
            ],
            listeners: {
                scope: this,
                afterrender: function() {
                    this._alert("The user story table has loaded.");
                }
            }
        });
        
        this.down('#grid_box').add(this.grid);
    }
    
});
Ext.define('Rally.technicalservices.accessible.Combobox', {
    
    extend: 'Ext.Component',
    alias: 'widget.tsaccessiblecombobox',
    
    // Default configuration parameters
    config: {
        store: null,        
        componentId : 'comboBox',
    },
        
    // Constructor
    initComponent: function(){
        this.callParent();
    },

    renderTpl: [
        '<select id={componentId}>',
        '<tpl for="data">',
            '<option value="{data._ref}">{data.Name}</option>',
        '</tpl>',
        '</select>'
    ],
    
    getTemplateArgs: function() {
        data = this.store.getRecords();
        return {
            componentId: this.componentId,
            data: this.store.getRecords()
        }
    },

    beforeRender: function() {
        var me = this;
        me.callParent();
        Ext.applyIf(me.renderData, me.getTemplateArgs());
    }
});

Ext.define('Rally.technicalservices.accessible.grid', {
    extend: 'Ext.Component',
    alias: 'widget.tsaccessiblegrid',
    config: {
        caption: null,
        title: 'Grid Title',
        store: null,
        columns: []
    },
    
    initComponent: function(){
        this.callParent();
    },
    
    renderTpl: [
        '<table border="1" cellspacing="1" cellpadding="1" summary="{summary}">',
        '<caption>{caption}</caption>',
        '<thead><tr>',
        '<tpl for="columns">',
        '<th scope="col">{text}</th>',
        '</tpl>',
        '</tr></thead>',
        '<tbody>',
            '<tpl for="data">',
                '<tr>',
                    '<tpl for="parent.columns">',
                        '<tpl if="xindex === 1">',
                            '<th scope="row">',                           
                            '{[parent.data[values.dataIndex]]}',
                            '</th>',
                        '</tpl>',                    
                        '<tpl if="xindex &gt; 1">',
                            '<td>',                          
                            '{[parent.data[values.dataIndex]]}',
                            '</td>',
                        '</tpl>',
                    '</tpl>',
                '</tr>',
            '</tpl>',
        '</tbody>',
        '</table>'
    ],
    
    renderTpl_past: [ '{html}'],
    
    getTemplateArgs: function() {
        
        return {
            summary: this.title,
            caption: this.caption || this.title,
            columns: this.columns,
            data: this.store.getRecords()
        }
    },
    
    beforeRender: function() {
        var me = this;
        me.callParent();
        
        Ext.applyIf(me.renderData, me.getTemplateArgs());
    }
    
});
/*
 * Straight override of parts of Ext components so we don't have to subclass them
 */

 // Change the template of the standard grid
 Ext.override(Ext.view.TableChunker,{
    metaTableTpl: [
        '{%if (this.openTableWrap)out.push(this.openTableWrap())%}',
        '<table role="grid" class="' + Ext.baseCSSPrefix + 'grid-table ' + Ext.baseCSSPrefix + 'grid-table-resizer" border="0" cellspacing="0" cellpadding="0" {[this.embedFullWidth(values)]}>',
            '<tbody>',
            '<tr class="' + Ext.baseCSSPrefix + 'grid-header-row">',
            '<tpl for="columns">',
                '<th class="' + Ext.baseCSSPrefix + 'grid-col-resizer-{id}" style="width: {width}px; height: 0px;"></th>',
            '</tpl>',
            '</tr>',
            '{[this.openRows()]}',
                '{row}',
                '<tpl for="features">',
                    '{[this.embedFeature(values, parent, xindex, xcount)]}',
                '</tpl>',
            '{[this.closeRows()]}',
            '</tbody>',
        '</table>',
        '{%if (this.closeTableWrap)out.push(this.closeTableWrap())%}'
    ]
 });
            
               Rally.launchApp('CustomApp', {
                   name: 'Accessible App'
               });
        });
    </script>
    
    
<link rel="stylesheet" type="text/css" href="src/style/app.css">

</head>
<body></body>
</html>